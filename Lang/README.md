# Полный гайд по функционалу Ассемблерного Компилятора

Этот документ представляет подробное руководство по функционалу компилятора ассемблера, написанного на Go. Здесь описаны все возможности, поддерживаемые инструкции и директивы, этапы компиляции, а также примеры использования и рекомендации по расширению.

---

## Содержание

- [Обзор](#обзор)
- [Поддерживаемые инструкции и директивы](#поддерживаемые-инструкции-и-директивы)
  - [Опкоды и форматы аргументов](#опкоды-и-форматы-аргументов)
  - [Директивы ассемблера](#директивы-ассемблера)
- [Этапы компиляции](#этапы-компиляции)
  - [Предварительная обработка](#предварительная-обработка)
  - [Расширение псевдоинструкций](#расширение-псевдоинструкций)
  - [Первый проход: Вычисление адресов меток](#первый-проход-вычисление-адресов-меток)
  - [Второй проход: Генерация байт-кода](#второй-проход-генерация-байт-кода)
- [Особенности и расширения псевдоинструкций](#особенности-и-расширения-псевдоинструкций)
  - [MOV с MOD](#mov-с-mod)
  - [Арифметические операции с немедленными операндами](#арифметические-операции-с-немедленными-операндами)
  - [Обработка инструкций READ и WRITE](#обработка-инструкций-read-и-write)
  - [Обработка адресных выражений](#обработка-адресных-выражений)
- [Инструкции по сборке и использованию](#инструкции-по-сборке-и-использованию)
- [Обработка ошибок и ограничения](#обработка-ошибок-и-ограничения)
- [Вклад и развитие проекта](#вклад-и-развитие-проекта)
- [Лицензия](#лицензия)
- [Заключение](#заключение)

---

## Обзор

Компилятор ассемблера предназначен для преобразования исходного кода на ассемблере в байт-код. Он поддерживает:

- Расширение псевдоинструкций (например, преобразование `MOV` с оператором `MOD`).
- Директивы для управления данными (.ASCIIZ, .SPACE, .BYTE, .WORD).
- Обработку комментариев и меток.
- Автоматическую загрузку немедленных значений во временные регистры для арифметических и специальных инструкций (например, `READ` и `WRITE`).

Компилятор реализован в два прохода:
1. **Первый проход:** Расширяет псевдоинструкции и вычисляет адреса меток.
2. **Второй проход:** Генерирует окончательный байт-код, записывая инструкции, аргументы и данные.

---

## Поддерживаемые инструкции и директивы

### Опкоды и форматы аргументов

Компилятор поддерживает набор инструкций, каждая из которых имеет свой уникальный опкод и ожидаемые типы аргументов. Ниже приведён список основных инструкций:

| Мнемоника  | Опкод  | Форматы аргументов          | Описание                                       |
|-----------|--------|-----------------------------|------------------------------------------------|
| NOP       | 0x00   | –                           | Нет операции                                   |
| HALT      | 0x01   | –                           | Остановка выполнения программы                 |
| JUMP      | 0x02   | addr                        | Безусловный переход                            |
| CALL      | 0x03   | addr                        | Вызов подпрограммы                             |
| RET       | 0x04   | –                           | Возврат из подпрограммы                        |
| IF        | 0x05   | flags, addr                 | Условный переход                               |
| LOAD      | 0x10   | reg, addr                   | Загрузка данных из памяти                      |
| STORE     | 0x11   | reg, addr                   | Сохранение данных в память                     |
| MOVE      | 0x12   | reg, reg                    | Перемещение данных между регистрами            |
| PUSH      | 0x13   | reg                         | Помещение регистра в стек                      |
| POP       | 0x14   | reg                         | Извлечение регистра из стека                   |
| LOADI     | 0x15   | reg, imm                    | Загрузка немедленного значения в регистр       |
| ADD       | 0x20   | reg, reg, reg               | Сложение                                       |
| SUB       | 0x21   | reg, reg, reg               | Вычитание (также поддерживается 2-операндная форма) |
| MUL       | 0x22   | reg, reg, reg               | Умножение                                      |
| DIV       | 0x23   | reg, reg, reg               | Деление                                        |
| AND       | 0x24   | reg, reg, reg               | Побитовое И                                    |
| OR        | 0x25   | reg, reg, reg               | Побитовое ИЛИ                                  |
| XOR       | 0x26   | reg, reg, reg               | Побитовое исключающее ИЛИ                      |
| NOT       | 0x27   | reg, reg                    | Побитовое НЕ                                   |
| CMP       | 0x28   | reg, imm                    | Сравнение                                      |
| SHL       | 0x30   | reg, reg, imm               | Побитовый сдвиг влево                          |
| SHR       | 0x31   | reg, reg, imm               | Побитовый сдвиг вправо                         |
| BREAK     | 0x32   | –                           | Отладочная точка                               |
| FS_LIST   | 0x34   | addr                        | Вывод списка файловой системы                  |
| ENV_LIST  | 0x42   | addr                        | Вывод списка переменных окружения              |
| PRINT     | 0x50   | reg                         | Вывод содержимого регистра                     |
| INPUT     | 0x51   | reg                         | Чтение значения в регистр                      |
| PRINTS    | 0x52   | addr                        | Вывод строки                                   |
| SNAPSHOT  | 0x60   | –                           | Создание снимка состояния                      |
| RESTORE   | 0x61   | –                           | Восстановление состояния                       |
| OPEN      | 0x70   | reg, reg, reg               | Открытие файла                                 |
| READ      | 0x71   | reg, reg, reg, reg          | Чтение из файла                                |
| WRITE     | 0x72   | reg, reg, reg, reg          | Запись в файл                                  |
| CLOSE     | 0x73   | reg                         | Закрытие файла                                 |
| SEEK      | 0x74   | reg, imm, imm, reg           | Изменение позиции в файле                      |

Типы аргументов:
- **reg:** регистр (один байт, номер от 0 до 31).
- **flags:** флаги, задающие условие (например, EQ, NE, LT, GT, GE).
- **addr:** адрес (4 байта, число в диапазоне 0–65535, может быть задан в виде константы или через метку).
- **imm:** немедленное значение (4 байта).

### Директивы ассемблера

Директивы позволяют задавать данные и зарезервированное пространство в байт-коде:

- **.ASCIIZ "строка"**  
  Записывает строковую константу с завершающим нулевым символом. Поддерживаются escape-последовательности (например, `\n`, `\t`).

- **.SPACE число**  
  Резервирует заданное количество байт памяти, инициализированных нулями.

- **.BYTE число**  
  Записывает 1-байтовое значение в код.

- **.WORD число**  
  Записывает 4-байтовое значение в формате Little Endian.

---

## Этапы компиляции

### Предварительная обработка

1. **Удаление комментариев и обрезка пробелов:**  
   Каждая строка обрабатывается функцией, которая удаляет комментарии (текст после `;`) и убирает лишние пробелы.

2. **Разделение метки и инструкции:**  
   Если строка содержит метку (до двоеточия), она отделяется от инструкции. Метки затем используются для вычисления адресов в первом проходе.

### Расширение псевдоинструкций

Перед непосредственным преобразованием в байт-код компилятор выполняет расширение псевдоинструкций:
- Некоторые инструкции могут преобразовываться в несколько строк кода.
- Пример: инструкция `MOV` с операцией `MOD` преобразуется в последовательность инструкций `DIV`, `MUL` и `SUB`.

### Первый проход: Вычисление адресов меток

В этом проходе компилятор:
- Пройдётся по всем строкам (с учётом расширенных псевдоинструкций).
- Вычисляет смещение (адрес) каждой инструкции, используя функцию расчёта длины строки.
- Сохраняет метки в таблице символов для последующей подстановки значений.

### Второй проход: Генерация байт-кода

После вычисления адресов меток:
- Компилятор повторно проходит по всем строкам.
- Генерирует байт-код, записывая опкоды, регистры и аргументы в последовательность байтов.
- Производит преобразование аргументов: если аргумент является немедленным значением или адресным выражением, выполняется конвертация в little endian формат.
- Формируется итоговый код с 4-байтовым заголовком, содержащим размер байт-кода.

---

## Особенности и расширения псевдоинструкций

### MOV с MOD

При использовании конструкции `MOV dest, X MOD Y` происходит расширение инструкции:
1. Выполняется деление: `DIV R30, X, Y`
2. Затем умножение: `MUL R31, R30, Y`
3. Вычисление остатка: `SUB dest, X, R31`

Это позволяет вычислить операцию `MOD` (остаток от деления) без отдельного опкода для неё.

### Арифметические операции с немедленными операндами

Для инструкций, таких как `ADD`, `SUB`, `MUL`, `DIV`, `AND`, `OR`, `XOR`:
- Если один из операндов не является регистром (например, число), компилятор автоматически добавляет инструкцию `LOADI` для загрузки значения во временный регистр (начиная с R30).
- В случае инструкции `SUB` с двумя операндами, автоматически преобразуется в формат с тремя операндами (вычитание выполняется как `SUB dest, dest, src`).

### Обработка инструкций READ и WRITE

Для инструкций `READ` и `WRITE`:
- Все операнды должны быть регистрами.
- Если операнд не является регистром, генерируется дополнительная инструкция `LOADI` для загрузки значения во временный регистр.

### Обработка адресных выражений

- Адрес может быть задан в виде константы или в квадратных скобках, например, `[100]` или `[R1]`.
- Если адрес задан как сложное выражение, например, `[imm + Rn]`, компилятор:
  - Генерирует инструкцию `LOADI R30, imm`
  - Выполняет сложение: `ADD R30, R30, Rn`
  - Использует результат (регистр R30) для дальнейшей работы, заменяя исходное выражение на `[R30]`.

---

## Инструкции по сборке и использованию

### Требования

- [Go](https://golang.org/) версии 1.16 или выше.

### Сборка проекта

1. **Клонирование репозитория:**

   ```bash
   git clone https://github.com/your-username/your-repo.git
   cd your-repo
   ```

2. **Компиляция:**

   ```bash
   go build -o asm-compiler main.go
   ```

### Запуск компилятора

Компилятор принимает два аргумента:
- Входной файл с ассемблерным кодом (например, `input.asm`).
- Выходной файл для сохранения байт-кода (например, `output.bin`).

Пример запуска:

```bash
./asm-compiler input.asm output.bin
```

При неверном количестве аргументов программа выводит сообщение с правильным синтаксисом:

```
Использование: asm-compiler [input.asm] [output.bin]
```

### Пример ассемблерного файла

```asm
; Пример программы
START:      LOADI R0, 10
            LOADI R1, 20
            ADD   R2, R0, R1
            PRINT R2
            HALT
```

После успешной компиляции байт-код сохраняется в указанном выходном файле с 4-байтовым заголовком, содержащим размер скомпилированного кода.

---

## Обработка ошибок и ограничения

- **Дублирование меток:**  
  Если одна и та же метка определена более одного раза, компилятор выдаст ошибку с указанием номера строки.

- **Неверное количество аргументов:**  
  При неправильном количестве аргументов для инструкции (не соответствует ожидаемому формату), выводится соответствующее сообщение об ошибке с номером строки.

- **Неподдерживаемые типы аргументов:**  
  Если тип аргумента не распознан (например, неизвестное имя или формат), происходит ошибка с подробным описанием проблемы.

- **Проверка диапазона значений:**  
  Для регистров (должны быть в диапазоне 0–31) и адресов (не превышающих 64К) проводятся проверки. При нарушении диапазона генерация кода прерывается с ошибкой.

- **Временные регистры:**  
  При автоматической загрузке немедленных значений используются регистры, начиная с R30. Если их не хватает, компилятор сообщает об ошибке.

---

## Вклад и развитие проекта

Мы приветствуем предложения и исправления ошибок. Если вы хотите внести вклад:

- Создайте pull request с вашими изменениями.
- Оформляйте issues для обсуждения новых возможностей или исправления ошибок.
- Пишите тесты для проверки нового функционала.

Перед отправкой pull request ознакомьтесь с [CONTRIBUTING.md](CONTRIBUTING.md) (если имеется) для соблюдения правил оформления и стандарта кода.

---

## Лицензия

Проект распространяется под лицензией MIT. Подробную информацию можно найти в файле [LICENSE](LICENSE).

---

## Заключение

Этот компилятор ассемблера представляет собой мощный инструмент для преобразования ассемблерного исходного кода в байт-код. Он поддерживает расширение псевдоинструкций, вычисление адресов меток, обработку различных типов аргументов и директив. Благодаря модульной архитектуре, проект легко расширяется и модифицируется в соответствии с требованиями пользователя.

